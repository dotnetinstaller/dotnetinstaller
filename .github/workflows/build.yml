name: Build

on:
  push:
    branches-ignore:    
      - 'gh-pages'
  pull_request:
    branches-ignore:    
      - 'gh-pages'

env:
  # set RestoreUseSkipNonexistentTargets=false so running "nuget.exe restore dni.sln" returns a successful exit code (0).
  # Otherwise, the following errors occur:
  # .\Samples\PackagedSetup\Simple\Simple.vdproj(1,1): error MSB4025: The project file could not be loaded. Data at the root level is invalid. Line 1, position 1. [dni.proj]
  # EXEC : warning : Error reading msbuild project information, ensure that your input solution or project file is valid. NETCore and UAP projects will be skipped, only packages.config files will be restored. [dni.proj]
  # dni.proj(130,5): error MSB3073: The command "ThirdParty\NuGet\NuGet.exe restore Dni.sln" exited with code -1.
  RestoreUseSkipNonexistentTargets: false

jobs:
  build:
    runs-on: windows-2019

    strategy:
      matrix:
        Configuration: [Debug, Release]

    steps:
    - name: Disable Windows Defender Real-time Monitoring
      run: Set-MpPreference -DisableRealtimeMonitoring $true
      shell: powershell

    - name: Disable Windows Defender Smart Screen
      run: Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System' -Name 'EnableSmartScreen' -Type DWord -Value 0
      shell: powershell

    - uses: actions/checkout@v2

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Download Win8.1 SDK
      shell: powershell
      run: |
        md C:\win81sdk
        Invoke-WebRequest -Method Get -Uri https://go.microsoft.com/fwlink/p/?LinkId=323507 -OutFile C:\win81sdk\sdksetup.exe -UseBasicParsing

    - name: Install Win8.1 SDK
      shell: powershell
      run: |
        Start-Process -Wait C:\win81sdk\sdksetup.exe -ArgumentList "/q", "/norestart", "/features", "OptionId.WindowsDesktopSoftwareDevelopmentKit", "OptionId.NetFxSoftwareDevelopmentKit"

    - name: Install Microsoft Visual C++ 2010 Runtime 10.0.40219
      # This is required for the test method 'testGetRelatedInstalledProducts' in 'dotNetInstallerToolsLibUnitTests\MsiUtilUnitTests.cpp' to succeed.
      # The windows-2016 virtual environment has an older version, Microsoft Visual C++ 2010 Runtime 10.0.30319.
      run: choco install vcredist2010 --version=10.0.40219.32503

    - name: Install .NET 6 SDK
      run: |
        Invoke-WebRequest -Uri "https://dot.net/v1/dotnet-install.ps1" -OutFile dotnet-install.ps1
        .\dotnet-install.ps1 -Version 6.0.413 -Architecture "x64" -InstallDir "C:\Program Files\dotnet" -NoPath -Verbose
        .\dotnet-install.ps1 -Version 6.0.413 -Architecture "x86" -InstallDir "C:\Program Files (x86)\dotnet" -NoPath -Verbose

    - name: dotnet version and info (x64)
      shell: cmd
      run: |
        "C:\Program Files\dotnet\dotnet.exe" --version
        "C:\Program Files\dotnet\dotnet.exe" --info

    - name: dotnet version and info (x86)
      shell: cmd
      run: |
        "C:\Program Files (x86)\dotnet\dotnet.exe" --version
        "C:\Program Files (x86)\dotnet\dotnet.exe" --info

    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: msbuild /t:all /m /p:Configuration=${{ matrix.Configuration }} .\dni.proj

    - name: Publish Failed Test Results Report
      if: github.event_name != 'pull_request'
      uses: dorny/test-reporter@v1
      with:
        name: Tests
        path: TestResults/*.trx
        reporter: dotnet-trx
        list-suites: 'failed'
        list-tests: 'failed'
        max-annotations: 50

    - name: Upload Test Result Files
      if: always()
      uses: actions/upload-artifact@v2.3.1
      with:
        name: TestResults-${{ matrix.Configuration }}
        path: .\**\TestResults\**\*.*

    - name: Upload Temp Logs
      if: failure()
      uses: actions/upload-artifact@v2.3.1
      with:
        name: TempLogs-${{ matrix.Configuration }}
        path: ${{ env.TEMP }}\*.log

    - name: Export Windows Event Logs
      if: failure()
      shell: cmd
      run: |
        wevtutil epl Application Application.evtx
        wevtutil epl Security Security.evtx
        wevtutil epl System System.evtx

    - name: Upload Windows Event Logs
      if: failure()
      uses: actions/upload-artifact@v2.3.1
      with:
        name: WindowsEventLogs-${{ matrix.Configuration }}
        path: .\*.evtx

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v2.3.1
      with:
        name: ${{ matrix.Configuration }}
        path: |
          .\target\${{ matrix.Configuration }}\dotNetInstaller.*.zip
          .\target\${{ matrix.Configuration }}\dotNetInstaller.*.msi
        if-no-files-found: error